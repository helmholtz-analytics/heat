name: Weekly Workflow

on:
    schedule:
        - cron: '0 6 * * 1'  # Runs at 06:00 UTC every Monday
    workflow_dispatch:

permissions:
    actions: read
    contents: read
    security-events: write
    pull-requests: write
jobs:
    codeql:
        name: CodeQL Analysis
        runs-on: ubuntu-latest
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
            with:
                egress-policy: audit
          - name: Checkout repository
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            # Initializes the CodeQL tools for scanning.
          - name: Initialize CodeQL
            uses: github/codeql-action/init@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
            with:
                languages: python
          - name: Perform CodeQL Analysis
            uses: github/codeql-action/analyze@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
            with:
                category: "/language:python"
    scorecard:
        name: Code Quality Scorecard
        runs-on: ubuntu-latest
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
            with:
                egress-policy: audit

          - name: "Checkout code"
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
            with:
                persist-credentials: false

          - name: "Run analysis"
            uses: ossf/scorecard-action@05b42c624433fc40578a4040d5cf5e36ddca8cde # v2.4.2
            with:
                results_file: results.sarif
                results_format: sarif
                # (Optional) "write" PAT token. Uncomment the `repo_token` line below if:
                # - you want to enable the Branch-Protection check on a *public* repository, or
                # - you are installing Scorecard on a *private* repository
                # To create the PAT, follow the steps in https://github.com/ossf/scorecard-action#authentication-with-pat.
                # repo_token: ${{ secrets.SCORECARD_TOKEN }}

                # Public repositories:
                #   - Publish results to OpenSSF REST API for easy access by consumers
                #   - Allows the repository to include the Scorecard badge.
                #   - See https://github.com/ossf/scorecard-action#publishing-results.
                # For private repositories:
                #   - `publish_results` will always be set to `false`, regardless
                #     of the value entered here.
                publish_results: true

            # Upload the results as artifacts (optional). Commenting out will disable uploads of run results in SARIF
            # format to the repository Actions tab.
          - name: "Upload artifact"
            uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
            with:
                name: SARIF file
                path: results.sarif
                retention-days: 5

            # Upload the results to GitHub's code scanning dashboard.
          - name: "Upload to code-scanning"
            uses: github/codeql-action/upload-sarif@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
            with:
                sarif_file: results.sarif
    check-links:
        runs-on: ubuntu-latest
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
            with:
                egress-policy: audit

          - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # master
          - uses: gaurav-nelson/github-action-markdown-link-check@5c5dfc0ac2e225883c0e5f03a85311ec2830d368 # v1
            # checks all markdown files from root but ignores subfolders
            # By Removing the max-depth variable we can modify it -> to check all the .md files in the entire repo.
            with:
                use-quiet-mode: 'yes'
                # Specifying yes to show only errors in the output
                use-verbose-mode: 'yes'
                # Specifying yes to show detailed HTTP status for checked links.
                max-depth: 0

    inactivity:
        name: Inactivity Management
        runs-on: ubuntu-latest
        steps:
          - name: Harden Runner
            uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
            with:
                egress-policy: audit

          - uses: actions/stale@5bef64f19d7facfb25b37b414482c7164d639639 # v9.1.0
            with:
                days-before-issue-stale: 60
                days-before-issue-close: 60
                stale-issue-label: "stale"
                stale-issue-message: "This issue is stale because it has been open for 60 days with no activity."
                close-issue-message: "This issue was closed because it has been inactive for 60 days since being marked as stale."
                days-before-pr-stale: 60
                days-before-pr-close: 60
                stale-pr-label: "stale"
                stale-pr-message: "This pull request is stale because it has been open for 60 days with no activity."
                close-pr-message: "This pull request was closed because it has been inactive for 60 days since being marked as stale."
                repo-token: ${{ secrets.GITHUB_TOKEN }}
