name: Support latest PyTorch

on:
  workflow_call:
    inputs:
      working_branch:
        required: true
        type: string
      base_branch:
        required: true
        type: string
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  latest-torch-support:
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - uses: JasonEtco/create-an-issue@1b14a70e4d8dc185e5cc76d3bec9eab20257b2c5 # v2.9.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id:
          create-issue
        with:
          filename: .github/ISSUE_TEMPLATE/support_latest_pytorch.md
          milestone: 1
          update_existing: true
          search_existing: open
      - name: Check out new branch
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: '${{ inputs.working_branch }}'
      - name: Set env variables
        run: |
          echo "previous_pytorch=$(grep 'torch~=' pyproject.toml | awk -F '<' '{print $2}' | tr -d '",')" >> $GITHUB_ENV
          echo "new_pytorch=$(<.github/pytorch-release-versions/pytorch-latest.txt)"  >> $GITHUB_ENV
      - name: Increment version
        run: |
          chmod +x .github/workflows/increment_version.sh
          echo "setup_pytorch=$(.github/workflows/increment_version.sh ${{ env.new_pytorch }})" >> $GITHUB_ENV
      - name: Update pyproject.toml
        run: |
          sed -i '/torch~=/ s/'"${{ env.previous_pytorch }}"'/'"${{ env.setup_pytorch }}"'/g' pyproject.toml
      - name: Create PR from branch
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
            base: ${{ inputs.base_branch }}
            branch: ${{ inputs.working_branch }}
            delete-branch: true
            token: ${{ secrets.GITHUB_TOKEN }}
            commit-message: Support latest PyTorch release
            title: Support PyTorch ${{ env.new_pytorch }}
            body: |
              Run tests on latest PyTorch release
              Issue/s resolved: #${{ steps.create-issue.outputs.number }}
              TODO:
              - [ ] update `.github/workflows/ci.yaml` to include latest Pytorch version
              - [ ] update Nvidia and AMD Docker images on gitlab CI
              Auto-generated by [create-pull-request][1]
              [1]: https://github.com/peter-evans/create-pull-request
            reviewers: ClaudiaComito, mtar, mrfh92
            labels: backport stable, interoperability
            draft: true
