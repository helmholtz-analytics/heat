name: Generate tutorial notebooks

on: push

jobs:
  generate_notebooks:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    name: Generate Notebooks
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup MPI
        uses: mpi4py/setup-mpi@3969f247e8fceef153418744f9d9ee6fdaeda29f # v1.2.0
        with:
          mpi: openmpi

      - name: Use Python 3.13
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: 3.13
          architecture: x64

      - name: Test
        run: |
          pip install jupytext
          python tutorials/interoperability.py
      - name: Run each .py file individually
        run: |
          set -e
          find ../tutorials/scripts/ -maxdepth 1 -type f -name "*.py" | while read -r file; do
            base="$(basename "$file" .py)"
            echo "Running $file and converting to ${base}.ipynb"
            mpirun -np 2 python "$file"
            mpirun -np 2 jupytext --to ipynb --execute $file -o tutorials/notebooks/${base}.ipynb
          done
